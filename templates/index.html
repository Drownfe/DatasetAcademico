<!doctype html>
<html lang="es">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>ğŸ“ PredicciÃ³n AcadÃ©mica â€” Notas y CrÃ©ditos</title>
  <link rel="stylesheet" href="{{ url_for('static', filename='style.css') }}?v=2" />
</head>
<body>
  <div class="container">
    <header>
      <h1>ğŸ“ PredicciÃ³n de Nota Final y CrÃ©ditos</h1>
      <p class="sub">Modelo de RegresiÃ³n Lineal con datos acadÃ©micos â€” demo interactiva</p>
    </header>

    <section class="card">
      <div class="hero">
        <p>Analiza el dataset, entrena el modelo y visualiza <b>X</b> (entradas) y <b>Y</b> (salidas).</p>
        <button id="startBtn" class="btn-primary">â–¶ï¸ Empezar</button>
      </div>

      <div id="steps" class="steps hidden">
        <div class="step"><div class="dot"></div><div class="label">1) Generando / cargando datasetâ€¦</div></div>
        <div class="step"><div class="dot"></div><div class="label">2) Separando variables X (entradas) y Y (salidas)â€¦</div></div>
        <div class="step"><div class="dot"></div><div class="label">3) Dividiendo en entrenamiento / prueba (80/20)â€¦</div></div>
        <div class="step"><div class="dot"></div><div class="label">4) Entrenando modelo para NotaFinalâ€¦</div></div>
        <div class="step"><div class="dot"></div><div class="label">5) Calculando mÃ©tricas (MSE, RMSE, RÂ²)â€¦</div></div>
        <div class="progress"><div class="bar" id="bar"></div></div>
      </div>

      <div id="result" class="result hidden">
        <h2>ğŸ“Š Resultados</h2>

        <div class="grid">
          <div class="box">
            <h3>ğŸ“¦ Dataset</h3>
            <p><b>Filas:</b> <span id="rows">â€“</span></p>
            <p><b>Columnas:</b> <span id="cols">â€“</span></p>
            <p><b>Entradas X:</b> <span id="xcols">â€“</span></p>
            <p><b>Salidas Y:</b> <span id="ycols">â€“</span></p>
            <p style="color:#9fc6ff;margin-top:6px;"><small id="note">â€“</small></p>

            <div class="policy">
              <h4>ğŸ¯ PolÃ­tica de CrÃ©ditos</h4>
              <ul id="policyList"></ul>
            </div>
          </div>

          <div class="box">
            <h3>ğŸ§  Modelo (predice <code>NotaFinal</code>)</h3>
            <p><b>MSE:</b> <span id="mse">â€“</span></p>
            <p><b>RMSE:</b> <span id="rmse">â€“</span> <small>(escala 0â€“5)</small></p>
            <p><b>RÂ²:</b> <span id="r2">â€“</span></p>
            <p><b>Intercepto:</b> <span id="intercept">â€“</span></p>
            <div id="coefs" class="coefs"></div>
          </div>
        </div>

        <h3>ğŸ”¢ Tabla X â€” Entradas (primeras filas)</h3>
        <div class="table-wrap">
          <table id="tableX"><thead></thead><tbody></tbody></table>
        </div>

        <h3>ğŸ¯ Tabla Y â€” Salidas (primeras filas)</h3>
        <div class="table-wrap">
          <table id="tableY"><thead></thead><tbody></tbody></table>
        </div>

        <div class="done">
          <span class="badge">âœ… Proceso completado</span>
          <p>El modelo estima <b>NotaFinal</b> (0â€“5) a partir de variables acadÃ©micas numÃ©ricas.
             Los <b>CrÃ©ditosAsignados</b> se determinan por polÃ­tica institucional segÃºn el <b>PromedioAcumulado</b>.</p>
        </div>
      </div>

      <div id="error" class="error hidden"></div>
    </section>

    <footer><p>Hecho con ğŸ’™ Flask + scikit-learn + CSS animations</p></footer>
  </div>

  <!-- JS embebido -->
  <script>
  const startBtn = document.getElementById("startBtn");
  const stepsEl = document.getElementById("steps");
  const resultEl = document.getElementById("result");
  const errorEl = document.getElementById("error");
  const barEl = document.getElementById("bar");

  const rowsEl = document.getElementById("rows");
  const colsEl = document.getElementById("cols");
  const xcolsEl = document.getElementById("xcols");
  const ycolsEl = document.getElementById("ycols");
  const noteEl = document.getElementById("note");
  const policyListEl = document.getElementById("policyList");

  const mseEl = document.getElementById("mse");
  const rmseEl = document.getElementById("rmse");
  const r2El = document.getElementById("r2");
  const interceptEl = document.getElementById("intercept");
  const coefsEl = document.getElementById("coefs");

  const tableX = document.getElementById("tableX");
  const tableY = document.getElementById("tableY");

  function markStepDone(idx) {
    const step = document.querySelectorAll(".step")[idx];
    if (step) step.classList.add("done");
    const progress = ((idx + 1) / document.querySelectorAll(".step").length) * 100;
    barEl.style.width = progress + "%";
  }

  function fillTable(table, rows) {
    if (!rows || rows.length === 0) return;
    const cols = Object.keys(rows[0]);
    const thead = table.querySelector("thead");
    const tbody = table.querySelector("tbody");
    thead.innerHTML = ""; tbody.innerHTML = "";

    const trHead = document.createElement("tr");
    cols.forEach(c => { const th = document.createElement("th"); th.textContent = c; trHead.appendChild(th); });
    thead.appendChild(trHead);

    rows.forEach(r => {
      const tr = document.createElement("tr");
      cols.forEach(c => { const td = document.createElement("td"); td.textContent = r[c]; tr.appendChild(td); });
      tbody.appendChild(tr);
    });
  }

  async function startPipeline() {
    startBtn.disabled = true;
    errorEl.classList.add("hidden");
    resultEl.classList.add("hidden");
    stepsEl.classList.remove("hidden");
    barEl.style.width = "0%";
    document.querySelectorAll(".step").forEach(s => s.classList.remove("done"));

    const tick = (i, d) => new Promise(res => setTimeout(() => { markStepDone(i); res(); }, d));
    await tick(0, 300); await tick(1, 300); await tick(2, 300); await tick(3, 300);

    try {
      const resp = await fetch("/start");
      const data = await resp.json();
      await tick(4, 300);

      if (!data.ok) throw new Error(data.error || "Error desconocido");
      const r = data.result;

      rowsEl.textContent = r.dataset_info.rows;
      colsEl.textContent = r.dataset_info.cols;
      xcolsEl.textContent = r.dataset_info.X_cols.join(", ");
      ycolsEl.textContent = r.dataset_info.Y_cols.join(", ");
      noteEl.textContent = r.dataset_info.note;

      policyListEl.innerHTML = "";
      r.dataset_info.policy_credits.forEach(rule => { const li = document.createElement("li"); li.textContent = rule; policyListEl.appendChild(li); });

      mseEl.textContent = r.metrics.mse.toFixed(4);
      rmseEl.textContent = r.metrics.rmse.toFixed(3);
      r2El.textContent = r.metrics.r2.toFixed(3);
      interceptEl.textContent = r.metrics.intercept.toFixed(4);

      coefsEl.innerHTML = "";
      Object.entries(r.metrics.coefs).forEach(([k, v]) => {
        const div = document.createElement("div");
        div.className = "pill";
        div.textContent = `${k}: ${v.toFixed(4)}`;
        coefsEl.appendChild(div);
      });

      fillTable(tableX, r.preview_X);
      fillTable(tableY, r.preview_Y);
      resultEl.classList.remove("hidden");
    } catch (err) {
      errorEl.textContent = "âš ï¸ " + err.message;
      errorEl.classList.remove("hidden");
    } finally {
      startBtn.disabled = false;
    }
  }

  startBtn.addEventListener("click", startPipeline);
  </script>
</body>
</html>
